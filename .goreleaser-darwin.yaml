version: 2
project_name: cloud-init
before:
  hooks:
    # You may remove this if you don't use go modules.
    - go mod tidy
    - go install github.com/swaggo/swag/cmd/swag@latest
    - swag init -g cmd/cloud-init-server/main.go  

builds:
  - id: darwin
    main: ./cmd/cloud-init-server
    binary: cloud-init-server
    # export GIT_STATE=$(if git diff-index --quiet HEAD --; then echo 'clean'; else echo 'dirty'; fi)
    # export BUILD_HOST=$(hostname)
    # export GO_VERSION=$(go version | awk '{print $3}')
    # export BUILD_USER=$(whoami)
    ldflags:
      - "-X 'main.GitCommit={{.Commit}}' \
         -X 'main.BuildTime={{.Timestamp}}' \
         -X 'main.Version={{.Version}}' \
         -X 'main.GitBranch={{.Branch}}' \
         -X 'main.GitTag={{.Tag}}' \
         -X 'main.GitState={{ .Env.GIT_STATE }}' \
         -X 'main.BuildHost={{ .Env.BUILD_HOST }}' \
         -X 'main.GoVersion={{ .Env.GO_VERSION }}' \
         -X 'main.BuildUser={{ .Env.BUILD_USER }}'"
    goos:
      - darwin
    goarch:
      - amd64
      - arm64
    goamd64:
      - v3
      - v1
    env:
      - CGO_ENABLED=1

# The lines beneath this are called `modelines`. See `:help modeline`
# Feel free to remove those if you don't want/use them.
# yaml-language-server: $schema=https://raw.githubusercontent.com/goreleaser/goreleaser/v2.11.2/www/docs/static/schema.json
# vim: set ts=2 sw=2 tw=0 fo=cnqoj